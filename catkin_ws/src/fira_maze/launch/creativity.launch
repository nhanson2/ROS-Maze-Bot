<launch>

  <param name="use_sim_time" value="true"/>
  <arg name="first_tb3"  default="tb3_0"/>
  <arg name="second_tb3" default="tb3_1"/>
  <!-- Launch Gazebo with world file  -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="$(find fira_maze)/worlds/maze_4.world"/>
    <arg name="paused" value="false"/>
    <arg name="use_sim_time" value="true"/>
    <arg name="gui" value="false"/>
    <arg name="headless" value="false"/>
    <arg name="debug" value="false"/>
  </include>
  <!-- Publish expected transforms -->
  <node pkg="tf"
          type="static_transform_publisher"
          name="robot_0_map_tf_broadcaster"
          args="0 0 0 0 0 0 /map /robot_0/odom 1000" output="screen"/>
    <node pkg="tf" 
          type="static_transform_publisher" 
          name="robot_1_map_tf_broadcaster"
          args="-3.1 0 0 0 0 0 /map /robot_1/odom 1000" output="screen"/>
  <!-- Start Rviz -->
  <node type="rviz" name="rviz" pkg="rviz" output="screen"/>


  <!-- Start Gmapping for Robot 1 -->
  <group ns="sim1">
    <node pkg="gmapping" type="slam_gmapping" name="slam_gmapping0" output="screen">
    <remap from="scan" to="/robot_0/base_scan"/>
    <param name="sigma" value="0.05"/>
    <param name="base_frame" value="/robot_0/base_link"/>
    <remap from="map" to="/map"/>
    <remap from="map_metadata" to="/map_metadata"/>
    </node>
  </group>
  <!-- Start Gmapping for robot 2 -->
  <group ns="sim1">
    <node pkg="gmapping" type="slam_gmapping" name="slam_gmapping1" output="screen">
    <remap from="scan" to="/robot_1/base_scan"/>
    <param name="sigma" value="0.05"/>
    <param name="base_frame" value="/robot_1/base_link"/>
    <remap from="map" to="/map"/>
    <remap from="map_metadata" to="/map_metadata"/>
    </node>
  </group>


    <group ns="first_tb3/map_merge">
      <param name="init_pose_x"   value="0"/>
      <param name="init_pose_y"   value="0"/>
      <param name="init_pose_z"   value="0"/>
      <param name="init_pose_yaw" value="0"  />
    </group>

    <group ns="second_tb3/map_merge">
      <param name="init_pose_x"   value="-3.1"/>
      <param name="init_pose_y"   value="0"/>
      <param name="init_pose_z"   value="0"/>
      <param name="init_pose_yaw" value="0"  />
    </group>


    <node pkg="multirobot_map_merge" type="map_merge" respawn="false" name="map_merge" output="screen">
      <param name="robot_map_topic" value="map"/>
      <param name="robot_namespace" value="tb"/>
      <param name="merged_map_topic" value="map_merged_2"/>
      <param name="world_frame" value="/map"/>
      <param name="known_init_poses" value="true"/>
      <param name="merging_rate" value="0.25"/>
      <param name="discovery_rate" value="0.05"/>
      <param name="estimation_rate" value="0.1"/>
      <param name="estimation_confidence" value="1.0"/>
    </node>

    <node pkg="tf" type="static_transform_publisher" name="world_to_$(arg first_tb3)_tf_broadcaster"  args="0 0 0 0 0 0 /map /$(arg first_tb3)/map 100"/>
    <node pkg="tf" type="static_transform_publisher" name="world_to_$(arg second_tb3)_tf_broadcaster" args="0 0 0 0 0 0 /map /$(arg second_tb3)/map 100"/>

</launch>